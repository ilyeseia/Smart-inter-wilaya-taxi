#!/bin/sh
#
# Copyright © 2015-2021 the original authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

##############################################################################
#
#   Maven start up script for POSIX generated by Maven.
#
#   IMPORTANT: Unlike bash/ksh/sh, zsh, fish, and other POSIX shells,
#   "mvn" below (and likely the Maven wrapper) does not require that
#   this script be sourced.  Instead, the source operation uses ./
#   to execute the script in the correct directory, while other shells
#   require running as "bash ./mvnw" or "ksh ./mvnw".
#
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
app_path=$0

# Need this for relative paths.
if [ -L "$app_path" ]; then
  # The test was failing with a circular link. Let's check the real file:
  app_path=$(readlink -f "$app_path")
fi

# Normalize the PATH variable
PATH="$PATH:$HOME/.m2/wrapper"
export PATH

# Find Maven wrapper.jar
if [ -f "$APP_HOME/.mvn/wrapper/maven-wrapper.jar" ]; then
  # Check if the jar exists.
  if [ -e "$APP_HOME/.mvn/wrapper/maven-wrapper.jar" ]; then
    true
  else
    echo "Could not find maven-wrapper.jar in $APP_HOME/.mvn/wrapper" >&2
    exit 1
  fi
fi

# Set environment variables for Maven
export MAVEN_USER_HOME="$HOME/.m2"
export MAVEN_PROJECT_DISCOVERY="$MAVEN_USER_HOME/.m2/project-discovery"

# For debugging, echo to the final line if this script fails.
if [ "$MAVEN_DEBUG" ]; then
  echo "Maven arguments: $@"
  echo "Java arguments: $JAVA_OPTS"
  echo "Maven home: $MAVEN_HOME"
fi

# Escape application args
save() {
  for i do printf %s\\n "$i" | sed "s/'/'\\\\''/g;1s/^/'/;\$s/\$/' \\\\/" ; done
  echo " "
}
APP_ARGS=$(save "$@")

# Collect all arguments for the java command, stacking in reverse order:
#   * args from the command line
#   * the main class name
#   * -classpath
#   * -D...appname settings
#   * --module-path (only if needed)
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and MAVEN_SKIP_RC environment variables.

# For Cygwin or MSYS, switch paths to Windows format before running java
if [ "$CYGWIN" = "true" -o "$MSYS" = "true" ] ; then
  APP_HOME=$(cygpath --path --mixed "$APP_HOME")
  CLASSPATH=$(cygpath --path --mixed "$CLASSPATH")
  JAVACMD=$(cygpath --unix "$JAVACMD")
fi

# Collect Java arguments and set properties as specified in jvm.config
set -- \
        -Dorg.apache.maven.global-settings="$MAVEN_USER_HOME/.m2/settings.xml" \
        -Dorg.apache.maven.project、世界.settings="$MAVEN_USER_HOME/.m2/settings.xml" \
        -jar \
        "$MAVEN_HOME/maven-wrapper/target/maven-wrapper.jar" \
        "$@"

# Stop when "xargs" is not available.
if ! command -v xargs >/dev/null 2>&1
then
    die "xargs is not available"
fi

# Use "xargs" to parse quoted args.
#
# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
#
# In Bash we could simply go:
#
#   readarray ARGS < <( xargs -n1 <"$CLINE" )
#
# but POSIX shell has neither arrays nor command substitution, so instead we
# post-process each arg (as a line of input to sed) to backslash-escape any
# character that might be a shell metacharacter, then use eval to parse and
# set the positional arguments, preserving all of the environment variables.
eval "set -- $(printf '%s\n' "$APP_ARGS" | xargs -n1 | sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' )"

# Set MAVEN_OPTIONAL_OPTS
MAVEN_OPTIONAL_OPTS=$MAVEN_OPTIONAL_OPTS --add-opens java.base/java.lang=ALL-UNNAMED

# Execute Java
exec "$JAVACMD" "$@"